#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure environment

set -o errexit  # always exit on error
set -o pipefail # dont ignore exit codes when piping output
set -o nounset  # fail on unset variables
unset GIT_DIR   # Avoid GIT_DIR leak from previous build steps

BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BUILDPACK_DIR=$(
  cd "$(dirname "${0:-}")" || exit
  cd ..
  pwd
)
BIN_DIR="$BUILD_DIR/.heroku/bin"
DEFAULT_NODE_VERSION=16

mkdir -p "$BUILD_DIR/.heroku/bin/"

cd "$BUILD_DIR"

### Load Dependencies
#source "$BUILDPACK_DIR/lib/environment.sh"
#source "$BUILDPACK_DIR/lib/json.sh"
#source "$BUILDPACK_DIR/lib/heroku.sh"

### Create and export environment variables
#create_env() {
#  write_profile "$BUILDPACK_DIR" "$BUILD_DIR"
#  export_env_dir "$ENV_DIR"
#}

#create_env

### Install binaries needed for build
install_binaries() {
  #local node_engine=$(read_json "$BUILD_DIR/package.json" ".engines.node")
  #local npm_engine=$(read_json "$BUILD_DIR/package.json" ".engines.npm")

  echo "-> Cloning ASDF..."
  git clone https://github.com/asdf-vm/asdf.git $BUILD_DIR/.asdf --branch v0.9.0

  rm -rf $BUILD_DIR/node_modules/
  export ASDF_DIR=$BUILD_DIR/.asdf
  export ASDF_DATA_DIR=$BUILD_DIR/.asdf
  export PATH=$BUILD_DIR/.asdf/bin/:$ASDF_DATA_DIR/shims/:$PATH

  echo "-> Adding asdf-nodejs"
  asdf plugin add nodejs
  echo "-> Adding asdf-pnpm"
  asdf plugin add pnpm

  echo "-> Installing nodejs from tool versions"
  asdf install nodejs
  echo "-> Installing pnpm from tool versions"
  asdf install pnpm

  ls -la $BUILD_DIR/.asdf/shims
  pnpm -v
}

install_binaries

echo "-> Run build"
pwd
pnpx prisma generate
echo "DONE"
pnpx next build

